<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Komanda app - Cadastro de Produtos</title>
    <link rel="icon" href="src/favicon_io/favicon-16x16.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="top-menu">
        <div class="logo-area">
            <a href="home.html"><img src="src/image.png" alt="Logo da Empresa"></a>
        </div>
        <nav>
            <ul class="menu-items">
                <li><a href="relatorio.html">Relatórios</a></li>
                <li><a href="cadastro.html">Cadastro</a></li>
            </ul>
        </nav>
    </header>

    <main class="main-content">
        <div class="content-section">
            <h1>Cadastro de Produtos</h1>
            
            <form id="formCadastro" class="form-cadastro">
                <input type="hidden" id="productId" name="productId">
                <div class="input-group">
                    <label for="nome">Nome do Produto</label>
                    <input type="text" id="nome" name="nome" placeholder="Ex: Litrão de brahma" required>
                </div>
                <div class="input-group">
                    <label for="preco">Preço Unitário</label>
                    <input type="number" id="preco" name="preco" step="0.01" placeholder="Ex: 12.00" required>
                </div>
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label for="descricao">Descrição</label>
                    <textarea id="descricao" name="descricao" rows="2" placeholder="Ex: Estupidamente gelado..."></textarea>
                </div>
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label for="categoria">Categoria do Produto</label>
                    <div class="input-with-button">
                        <select id="categoria" name="categoria" required>
                            <option value="">Selecione uma categoria...</option>
                        </select>
                        <button type="button" class="btn-acao" id="btnNovaCategoria">Nova</button>
                        <button type="button" class="btn-acao" id="btnExcluirCategoria">Excluir</button>
                    </div>
                </div>
                <button type="submit" id="btnSubmit" class="btn-cadastrar">Cadastrar Produto</button>
            </form>

            <div class="product-list-container">
                <div class="product-list-actions">
                    <h2>Produtos Cadastrados</h2>
                    <button class="btn-acao" id="btnExcluirSelecionados">Excluir Selecionados</button>
                </div>
                
                <table class="product-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="checkAll"></th>
                            <th>ID</th>
                            <th>Nome do Produto</th>
                            <th>Preço (R$)</th>
                            <th>Categoria</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <script>
        const produtosApiUrl = 'http://localhost:3000/api/produtos';
        const categoriasApiUrl = 'http://localhost:3000/api/categorias';

        const form = document.getElementById('formCadastro');
        const productTableBody = document.getElementById('productTableBody');
        const btnSubmit = document.getElementById('btnSubmit');
        const inputId = document.getElementById('productId');
        const selectCategoria = document.getElementById('categoria');
        const btnNovaCategoria = document.getElementById('btnNovaCategoria');
        const btnExcluirCategoria = document.getElementById('btnExcluirCategoria');
        const btnExcluirSelecionados = document.getElementById('btnExcluirSelecionados');
        const checkAll = document.getElementById('checkAll'); // NOVO: Seleciona o checkbox 'selecionar todos'

        async function fetchProducts() {
            try {
                const response = await fetch(produtosApiUrl);
                const products = await response.json();
                
                productTableBody.innerHTML = '';
                
                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" data-id="${product.id_produto}"></td>
                        <td>${product.id_produto}</td>
                        <td>${product.nome_produto}</td>
                        <td>${parseFloat(product.preco_unitario).toFixed(2)}</td>
                        <td>${product.nome_categoria || 'Sem Categoria'}</td>
                        <td class="action-buttons">
                            <button class="btn-edit" data-id="${product.id_produto}" data-name="${product.nome_produto}" data-price="${product.preco_unitario}" data-description="${product.descricao}" data-category-id="${product.id_categoria}">Editar</button>
                            <button class="btn-delete" data-id="${product.id_produto}">Excluir</button>
                        </td>
                    `;
                    productTableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Erro ao buscar produtos:', error);
                alert('Não foi possível carregar os produtos. Verifique se o servidor está rodando.');
            }
        }

        async function fetchCategories() {
            try {
                const response = await fetch(categoriasApiUrl);
                const categories = await response.json();
                
                selectCategoria.innerHTML = '<option value="">Selecione uma categoria...</option>';

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id_categoria;
                    option.textContent = category.nome_categoria;
                    selectCategoria.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao buscar categorias:', error);
            }
        }

        async function addProduct(productData) {
            try {
                const response = await fetch(produtosApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                
                if (response.ok) {
                    alert('Produto cadastrado com sucesso!');
                    form.reset();
                    fetchProducts();
                } else {
                    alert('Erro ao cadastrar produto.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Não foi possível conectar ao servidor.');
            }
        }

        async function updateProduct(id, productData) {
            try {
                const response = await fetch(`${produtosApiUrl}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                
                if (response.ok) {
                    alert('Produto atualizado com sucesso!');
                    form.reset();
                    btnSubmit.textContent = 'Cadastrar Produto';
                    inputId.value = '';
                    fetchProducts();
                } else {
                    alert('Erro ao atualizar produto.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Não foi possível conectar ao servidor.');
            }
        }

        async function deleteProduct(id) {
            const confirmDelete = confirm('Tem certeza que deseja excluir este produto?');
            if (!confirmDelete) return;

            try {
                const response = await fetch(`${produtosApiUrl}/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Produto excluído com sucesso!');
                    fetchProducts();
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Erro ao excluir produto.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Não foi possível conectar ao servidor.');
            }
        }

        async function addCategory() {
            const newCategoryName = prompt('Digite o nome da nova categoria:');
            if (!newCategoryName) {
                return;
            }

            try {
                const response = await fetch(categoriasApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome: newCategoryName })
                });

                if (response.ok) {
                    alert('Categoria adicionada com sucesso!');
                    fetchCategories();
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Erro ao adicionar categoria. Verifique se o nome já existe.');
                }
            } catch (error) {
                console.error('Erro ao adicionar categoria:', error);
                alert('Não foi possível conectar ao servidor para adicionar a categoria.');
            }
        }

        async function deleteCategory() {
            const categoryToDeleteId = selectCategoria.value;
            const categoryToDeleteName = selectCategoria.options[selectCategoria.selectedIndex].text;

            if (!categoryToDeleteId) {
                alert('Selecione uma categoria para excluir.');
                return;
            }

            const confirmDelete = confirm(`Tem certeza que deseja excluir a categoria "${categoryToDeleteName}"?`);
            if (!confirmDelete) return;

            try {
                const response = await fetch(`${categoriasApiUrl}/${categoryToDeleteId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Categoria excluída com sucesso!');
                    fetchCategories();
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Erro ao excluir categoria.');
                }
            } catch (error) {
                console.error('Erro ao excluir categoria:', error);
                alert('Não foi possível conectar ao servidor para excluir a categoria.');
            }
        }

        async function deleteSelectedProducts() {
            const selectedCheckboxes = document.querySelectorAll('#productTableBody input[type="checkbox"]:checked');

            if (selectedCheckboxes.length === 0) {
                alert('Selecione pelo menos um produto para excluir.');
                return;
            }
            
            const confirmDelete = confirm(`Tem certeza que deseja excluir ${selectedCheckboxes.length} produto(s) selecionado(s)?`);
            if (!confirmDelete) return;

            const deletePromises = [];
            
            selectedCheckboxes.forEach(checkbox => {
                const productId = checkbox.dataset.id;
                deletePromises.push(
                    fetch(`${produtosApiUrl}/${productId}`, {
                        method: 'DELETE'
                    })
                );
            });
            
            try {
                await Promise.all(deletePromises);
                alert('Itens selecionados excluídos com sucesso!');
                fetchProducts();
            } catch (error) {
                console.error('Erro ao excluir múltiplos produtos:', error);
                alert('Ocorreu um erro ao excluir um ou mais produtos.');
            }
        }

        // Event Listeners
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const nome = document.getElementById('nome').value;
            const preco = document.getElementById('preco').value;
            const descricao = document.getElementById('descricao').value;
            const id_categoria = selectCategoria.value;

            const productData = {
                nome: nome,
                preco: parseFloat(preco),
                descricao: descricao,
                id_categoria: id_categoria
            };

            const idToUpdate = inputId.value;
            if (idToUpdate) {
                updateProduct(idToUpdate, productData);
            } else {
                addProduct(productData);
            }
        });

        productTableBody.addEventListener('click', function(event) {
            const target = event.target;
            
            if (target.classList.contains('btn-edit')) {
                const id = target.dataset.id;
                const name = target.dataset.name;
                const price = target.dataset.price;
                const description = target.dataset.description;
                const categoryId = target.dataset.categoryId;
                
                document.getElementById('nome').value = name;
                document.getElementById('preco').value = price;
                document.getElementById('descricao').value = description;
                selectCategoria.value = categoryId;
                
                inputId.value = id;
                btnSubmit.textContent = 'Salvar Alterações';
            } 
            
            if (target.classList.contains('btn-delete')) {
                const id = target.dataset.id;
                deleteProduct(id);
            }
        });

        btnNovaCategoria.addEventListener('click', addCategory);
        btnExcluirCategoria.addEventListener('click', deleteCategory);
        btnExcluirSelecionados.addEventListener('click', deleteSelectedProducts);
        
        // NOVO: Evento para o checkbox "Selecionar Todos"
        checkAll.addEventListener('change', function() {
            const isChecked = this.checked;
            const productCheckboxes = document.querySelectorAll('#productTableBody input[type="checkbox"]');
            productCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchCategories();
            fetchProducts();
        });
    </script>
</body>
</html>