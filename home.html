<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Komanda app - Vendas</title>
    <link rel="icon" href="src/favicon_io/favicon-16x16.png" type="image/x-icon">
    <link rel="stylesheet" href="vendas.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Montserrat:wght@700&display=swap" rel="stylesheet">
</head>
<body>

    <header class="top-menu">
        <div class="logo-area">
            <a href="home.html"><img src="src/image.png" alt="Logo da Empresa"></a>
        </div>
        <nav>
            <ul class="menu-items">
                <li><a href="relatorio.html">Relatórios</a></li>
                <li><a href="cadastro.html">Cadastro</a></li>
            </ul>
        </nav>
    </header>

    <main class="main-content">
        <div class="content-section">
            <h1>Mesas e Comandas</h1>
            
            <div class="order-grid" id="orderGrid">
                <div class="order-card add-new-table" id="btnAddMesa">
                    <h3 class="title">+</h3>
                </div>
            </div>
        </div>
    </main>

    <script>
        const vendasApiUrl = 'http://localhost:3000/api/vendas';
        const produtosApiUrl = 'http://localhost:3000/api/produtos';
        const orderGrid = document.getElementById('orderGrid');
        const totalMesasFixas = 10;
        let expandedContainer = null;

        /**
         * Renderiza as mesas fixas e atualiza o estado com as comandas abertas.
         */
        async function renderMesas() {
            // Remove todos os cards existentes para evitar duplicação
            const cardsToRemove = document.querySelectorAll('.order-card:not(.add-new-table)');
            cardsToRemove.forEach(card => card.remove());

            // Cria e insere os cards das mesas fixas
            for (let i = 1; i <= totalMesasFixas; i++) {
                const card = createMesaCard(`Mesa ${i}`, i, 'Comanda vazia');
                orderGrid.insertBefore(card, document.getElementById('btnAddMesa'));
            }

            // Atualiza os cards das mesas que possuem comandas abertas
            await fetchVendasAbertas();
        }

        /**
         * Cria e retorna um elemento de card de mesa.
         * @param {string} title O título da mesa.
         * @param {string|number} mesaId O identificador da mesa.
         * @param {string} subtitle O subtítulo do card.
         * @returns {HTMLElement} O card de mesa criado.
         */
        function createMesaCard(title, mesaId, subtitle) {
            const card = document.createElement('div');
            card.classList.add('order-card');
            card.dataset.mesa = mesaId;
            card.innerHTML = `
                <h3 class="title">${title}</h3>
                <p class="subtitle">${subtitle}</p>
            `;
            return card;
        }

        /**
         * Busca vendas abertas e atualiza a interface.
         */
        async function fetchVendasAbertas() {
            try {
                const response = await fetch(`${vendasApiUrl}/abertas`);
                const vendasAbertas = await response.json();
                
                // Mapeia mesas abertas para fácil acesso
                const mesasAbertas = {};
                const mesasDinamicasAbertas = [];
                vendasAbertas.forEach(venda => {
                    if (parseInt(venda.numero_mesa) > totalMesasFixas) {
                        mesasDinamicasAbertas.push(venda);
                    }
                    mesasAbertas[venda.numero_mesa] = venda;
                });
                
                // Primeiro, remove todos os cards existentes para garantir que a renderização está limpa
                const cardsToRemove = document.querySelectorAll('.order-card:not(.add-new-table)');
                cardsToRemove.forEach(card => card.remove());

                // Em seguida, renderiza as mesas fixas
                for (let i = 1; i <= totalMesasFixas; i++) {
                    const card = createMesaCard(`Mesa ${i}`, i, 'Comanda vazia');
                    orderGrid.insertBefore(card, document.getElementById('btnAddMesa'));
                }

                // E agora, renderiza as mesas dinâmicas abertas
                mesasDinamicasAbertas.forEach(venda => {
                    const card = createMesaCard(`Mesa ${venda.numero_mesa}`, venda.numero_mesa, 'Comanda vazia');
                    orderGrid.insertBefore(card, document.getElementById('btnAddMesa'));
                });

                // Finalmente, atualiza o estado de todas as mesas (fixas e dinâmicas)
                const todosOsCards = document.querySelectorAll('.order-card:not(.add-new-table)');
                todosOsCards.forEach(card => {
                    const numeroMesa = card.dataset.mesa;
                    if (mesasAbertas[numeroMesa]) {
                        const venda = mesasAbertas[numeroMesa];
                        card.classList.add('open');
                        card.dataset.idVenda = venda.id_venda;
                        const total = parseFloat(venda.total_venda).toFixed(2);
                        card.innerHTML = `
                            <h3 class="title">Mesa ${venda.numero_mesa}</h3>
                            <p class="subtitle">Total: R$ ${total}</p>
                            <p class="items-count">(${venda.total_itens} itens)</p>
                        `;
                    }
                });

            } catch (error) {
                console.error('Erro ao buscar vendas abertas:', error);
                alert('Não foi possível carregar as comandas. Verifique se o servidor está rodando.');
            }
        }
        
        async function abrirComanda(numeroMesa) {
            try {
                const response = await fetch(`${vendasApiUrl}/abrir`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numero_mesa: numeroMesa })
                });

                if (response.ok) {
                    const novaComanda = await response.json();
                    await fetchVendasAbertas();
                    const card = document.querySelector(`.order-card[data-mesa="${numeroMesa}"]`);
                    if(card) expandirComanda(card, novaComanda.id_venda);
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Erro ao abrir a comanda.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Não foi possível conectar ao servidor. Verifique se ele está rodando.');
            }
        }

        async function fecharComanda(idVenda) {
            const metodoPagamento = prompt('Método de pagamento: (1) Dinheiro, (2) Cartão/Pix');
            if (metodoPagamento !== '1' && metodoPagamento !== '2') {
                alert('Método de pagamento inválido.');
                return;
            }
            const pagamento = metodoPagamento === '1' ? 'dinheiro' : 'cartao/pix';

            const confirmacao = confirm('Deseja realmente fechar esta comanda?');
            if (!confirmacao) return;

            try {
                const response = await fetch(`${vendasApiUrl}/${idVenda}/fechar`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ metodo_pagamento: pagamento })
                });

                if (response.ok) {
                    alert('Comanda fechada com sucesso!');
                    fecharDetalhes();
                    fetchVendasAbertas();
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Erro ao fechar comanda.');
                }
            } catch (error) {
                console.error('Erro ao fechar comanda:', error);
                alert('Não foi possível conectar ao servidor para fechar a comanda.');
            }
        }

        async function excluirComanda(idVenda) {
            const confirmacao = confirm('Deseja realmente EXCLUIR esta comanda? Esta ação é irreversível.');
            if (!confirmacao) return;

            try {
                const response = await fetch(`${vendasApiUrl}/${idVenda}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Comanda excluída com sucesso!');
                    fecharDetalhes();
                    fetchVendasAbertas();
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Erro ao excluir comanda.');
                }
            } catch (error) {
                console.error('Erro ao excluir comanda:', error);
                alert('Não foi possível conectar ao servidor para excluir a comanda.');
            }
        }

        async function expandirComanda(card, idVenda) {
            fecharDetalhes();

            try {
                const [vendaResponse, productsResponse] = await Promise.all([
                    fetch(`${vendasApiUrl}/${idVenda}`),
                    fetch(produtosApiUrl)
                ]);
                const venda = await vendaResponse.json();
                const products = await productsResponse.json();
                
                const productsListOptions = products.map(p => 
                    `<option value="${p.id_produto}">${p.nome_produto} - R$ ${parseFloat(p.preco_unitario).toFixed(2)}</option>`
                ).join('');

                const container = document.createElement('div');
                container.classList.add('order-details-container');
                
                const totalVenda = venda.total ? parseFloat(venda.total).toFixed(2) : '0.00';

                container.innerHTML = `
                    <div class="order-details-content">
                        <div>
                            <h3>Itens da Comanda</h3>
                            <ul class="order-items-list" id="orderItemsList-${idVenda}">
                                ${venda.items && venda.items.length > 0 ? venda.items.map(item => `
                                    <li data-id-item="${item.id_item_venda}">
                                        <span>${item.quantidade}x ${item.nome_produto}</span>
                                        <div class="item-actions">
                                            <span>R$ ${parseFloat(item.preco_unitario_no_momento * item.quantidade).toFixed(2)}</span>
                                            <button class="btn-remove-item" data-id-item="${item.id_item_venda}">X</button>
                                        </div>
                                    </li>
                                `).join('') : '<p>Nenhum item adicionado.</p>'}
                            </ul>
                        </div>
                        <div class="order-summary">
                            <div>
                                <h3>Adicionar Item</h3>
                                <form class="add-item-form" data-venda-id="${idVenda}">
                                    <select id="selectProduto-${idVenda}" required>
                                        <option value="">Selecione um produto...</option>
                                        ${productsListOptions}
                                    </select>
                                    <input type="number" id="quantidade-${idVenda}" placeholder="Qtd" min="1" value="1" required>
                                    <button type="submit">Adicionar</button>
                                </form>
                            </div>
                            <div>
                                <div class="total">
                                    <span>Total:</span>
                                    <span>R$ ${totalVenda}</span>
                                </div>
                                <div class="action-buttons" style="margin-top: 20px;">
                                    <button class="btn-finalize" data-venda-id="${idVenda}">Finalizar Venda</button>
                                    <button class="btn-delete-order" data-venda-id="${idVenda}">Excluir Comanda</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                card.insertAdjacentElement('afterend', container);
                expandedContainer = container;
                setupFormEventListeners(idVenda, card);

            } catch (error) {
                console.error('Erro ao expandir comanda:', error);
                alert('Não foi possível carregar os detalhes da comanda.');
            }
        }

        function setupFormEventListeners(idVenda, card) {
            const formAddItem = expandedContainer.querySelector('.add-item-form');
            formAddItem.addEventListener('submit', async (e) => {
                e.preventDefault();
                const idProduto = document.getElementById(`selectProduto-${idVenda}`).value;
                const quantidade = document.getElementById(`quantidade-${idVenda}`).value;
                await adicionarItem(idVenda, idProduto, quantidade);
                expandirComanda(card, idVenda);
            });

            const btnFinalize = expandedContainer.querySelector('.btn-finalize');
            btnFinalize.addEventListener('click', () => fecharComanda(idVenda));

            const btnExcluirComanda = expandedContainer.querySelector('.btn-delete-order');
            btnExcluirComanda.addEventListener('click', () => excluirComanda(idVenda));

            const itemsList = expandedContainer.querySelector('.order-items-list');
            itemsList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('btn-remove-item')) {
                    const idItem = e.target.dataset.idItem;
                    await removerItem(idVenda, idItem);
                    expandirComanda(card, idVenda);
                }
            });
        }

        function fecharDetalhes() {
            if (expandedContainer) {
                expandedContainer.remove();
                expandedContainer = null;
            }
        }

        async function adicionarItem(idVenda, idProduto, quantidade) {
            try {
                const response = await fetch(`${vendasApiUrl}/${idVenda}/item`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_produto: idProduto, quantidade: quantidade })
                });
                
                if (response.ok) {
                    alert('Item adicionado com sucesso!');
                    await fetchVendasAbertas();
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Erro ao adicionar item.');
                }
            } catch (error) {
                console.error('Erro ao adicionar item:', error);
                alert('Não foi possível conectar ao servidor.');
            }
        }

        async function removerItem(idVenda, idItem) {
            const confirmacao = confirm('Deseja realmente remover este item?');
            if (!confirmacao) return;

            try {
                const response = await fetch(`${vendasApiUrl}/${idVenda}/item/${idItem}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Item removido com sucesso!');
                    await fetchVendasAbertas();
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Erro ao remover item.');
                }
            } catch (error) {
                console.error('Erro ao remover item:', error);
                alert('Não foi possível conectar ao servidor.');
            }
        }

        async function handleCardClick(event) {
            const card = event.target.closest('.order-card');
            if (!card) return;

            const idVenda = card.dataset.idVenda;
            const numeroMesa = card.dataset.mesa;

            if (card.id === 'btnAddMesa') {
                const mesasExistentes = document.querySelectorAll('.order-card:not(.add-new-table)');
                let proximoNumero = totalMesasFixas + 1;
                const numeros = Array.from(mesasExistentes).map(m => parseInt(m.dataset.mesa)).filter(n => !isNaN(n));
                if (numeros.length > 0) {
                    proximoNumero = Math.max(...numeros) + 1;
                }
                
                await abrirComanda(proximoNumero);
                return;
            }

            if (expandedContainer && expandedContainer.previousElementSibling === card) {
                fecharDetalhes();
                return;
            }

            if (idVenda) {
                expandirComanda(card, idVenda);
            } else {
                await abrirComanda(numeroMesa);
            }
        }

        function setupEventListeners() {
            orderGrid.addEventListener('click', handleCardClick);
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderMesas();
            setupEventListeners();
        });
    </script>
</body>
</html>